name: Test

on:
  pull_request:
    branches: [main]

  push:
    branches: [main]

  schedule:
    - cron: '0 16 * * *'

  workflow_dispatch:

permissions:
  contents: read

env:
  # Configure Node.js memory limit to 6GB (default GitHub Actions limit is 7GB)
  NODE_OPTIONS: --max-old-space-size=6144

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.changes.outputs.changed }}
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 1

      - uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        id: changes
        with:
          predicate-quantifier: 'every'
          filters: |
            changed:
              - "!**/*.md"
              - "!**/*.mdx"
              - "!**/_meta.json"
              - "!**/dictionary.txt"

  # ======== ut ========
  ut:
    needs: prepare
    if: needs.prepare.outputs.changed == 'true' || github.event_name == 'schedule'
    runs-on: ${{ matrix.os }}
    timeout-minutes: 15
    strategy:
      matrix:
        # run ut in macOS, as SWC cases will fail in Ubuntu CI
        os: [macos-14, windows-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 1

      - name: Setup pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0

      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: 22
          cache: 'pnpm'
          cache-dependency-path: pnpm-lock.yaml

      - name: pnpm fetch
        run: pnpm fetch

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile --prefer-offline

      - name: Set Playwright cache path
        shell: bash
        run: |
          if [ "$RUNNER_OS" = "Windows" ]; then
            echo "PLAYWRIGHT_BROWSERS_PATH=$USERPROFILE/AppData/Local/ms-playwright" >> "$GITHUB_ENV"
          else
            echo "PLAYWRIGHT_BROWSERS_PATH=$HOME/Library/Caches/ms-playwright" >> "$GITHUB_ENV"
          fi

      - name: Cache Playwright Browsers
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: ${{ env.PLAYWRIGHT_BROWSERS_PATH }}
          key: playwright-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}

      - name: Install Playwright Browsers
        run: npx playwright install chromium webkit

      - name: Run Type Check
        run: pnpm run typecheck

      - name: Run Test
        run: pnpm run test

  # ======== e2e ========
  e2e:
    needs: [prepare, ut]
    if: needs.prepare.outputs.changed == 'true' || github.event_name == 'schedule'
    runs-on: ${{ matrix.os }}
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        # run ut in macOS, as SWC cases will fail in Ubuntu CI
        os: [macos-14, windows-latest]
        node_version: ${{ fromJson(github.event_name == 'schedule' && '["20","22","24"]' || '["20","24"]') }}

    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 1

      - name: Setup pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0

      - name: Setup Node.js ${{ matrix.node_version }}
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: ${{ matrix.node_version }}
          cache: 'pnpm'
          cache-dependency-path: pnpm-lock.yaml

      - name: pnpm fetch
        run: pnpm fetch

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile --prefer-offline

      - name: Set Playwright cache path
        shell: bash
        run: |
          if [ "$RUNNER_OS" = "Windows" ]; then
            echo "PLAYWRIGHT_BROWSERS_PATH=$USERPROFILE/AppData/Local/ms-playwright" >> "$GITHUB_ENV"
          else
            echo "PLAYWRIGHT_BROWSERS_PATH=$HOME/Library/Caches/ms-playwright" >> "$GITHUB_ENV"
          fi

      - name: Cache Playwright Browsers
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: ${{ env.PLAYWRIGHT_BROWSERS_PATH }}
          key: playwright-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}

      - name: Install Playwright Browsers
        run: npx playwright install chromium webkit

      - name: E2E Test
        run: cd e2e && pnpm test

      - name: E2E Test (CommonJS)
        run: cd e2e && pnpm test:commonjs
                
      - name: E2E Test (No Isolate)
        run: cd e2e && pnpm test:no-isolate

      - name: VS Code Extension Test
        run: pnpm run test:vscode

  # ======== gate ========
  test-gate:
    needs: [prepare, ut, e2e]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Check test requirement
        run: |
          if [ "${{ github.event_name }}" = "schedule" ] || [ "${{ needs.prepare.outputs.changed }}" = "true" ]; then
            [ "${{ needs.ut.result }}" = "success" ] && [ "${{ needs.e2e.result }}" = "success" ]
          fi
