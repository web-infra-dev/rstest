# Rslib

This guide covers how to integrate Rstest with [Rslib](https://rslib.rs) for seamless testing in your Rslib projects.

## Quick start

### New project

Create a new Rslib + Rstest project. Add the `--tools rstest` flag when creating:

```bash
npx create-rslib --template react-ts --tools rstest --dir my-project
```

The scaffold includes Rstest and demo tests. Run them with `npm run test`.

### Existing project

To add Rstest to an existing project, follow the [Quick Start](/guide/start/quick-start) to install and set up test scripts.

## Reuse Rslib config

[@rstest/adapter-rslib](https://www.npmjs.com/package/@rstest/adapter-rslib) is an official adapter that allows Rstest to automatically inherit configuration from your existing Rslib config file. This ensures your test environment matches your build configuration without duplication.

### Install adapter

import { PackageManagerTabs } from '@theme';

<PackageManagerTabs command="add @rstest/adapter-rslib -D" />

### Extend your config

Using the `withRslibConfig` function from the adapter, you can extend your Rstest configuration from the Rslib config file.

```typescript
import { defineConfig } from '@rstest/core';
import { withRslibConfig } from '@rstest/adapter-rslib';

export default defineConfig({
  extends: withRslibConfig(),
  // Additional rstest-specific configuration
});
```

This will automatically:

- Load your `rslib.config.ts` file
- Map compatible Rslib options to Rstest configuration
- Merge with any additional Rstest config you provide

By default, the adapter uses `process.cwd()` to resolve the Rslib config. If your config lives elsewhere, you can use the `cwd` option. See [API](#api) for more details.

## API

### `withRslibConfig(options)`

Returns a configuration function that loads Rslib config and converts it to Rstest configuration.

#### `cwd`

- **Type:** `string`
- **Default:** `process.cwd()`

The `cwd` is the working directory to resolve the Rslib config file.

When your Rslib config is in a different directory or you are running tests in a monorepo (where your `process.cwd()` is not your config directory), you can specify the `cwd` option to resolve the Rslib config file from a different directory.

```ts
export default defineConfig({
  extends: withRslibConfig({
    cwd: './packages/my-lib',
  }),
});
```

#### `configPath`

- **Type:** `string`
- **Default:** `'./rslib.config.ts'`

Path to rslib config file.

#### `libId`

- **Type:** `string`
- **Default:** `undefined`

The lib config id in `lib` field to use. Set to a string to use the lib config with matching id.

By default, the adapter uses the common configuration from Rslib. If your Rslib config has multiple lib configurations:

```ts
// rslib.config.ts
export default defineConfig({
  lib: [
    {
      id: 'core',
      format: 'esm',
      dts: true,
      source: {
        define: {
          IS_CORE: true,
        },
      },
    },
    {
      id: 'utils',
      format: 'esm',
      source: {
        define: {
          IS_CORE: false,
        },
      },
    },
  ],
  // shared config
});
```

You can then reference specific lib configurations in your Rstest config. Rstest will adapt the Rslib shared configuration and the lib configuration with a matching `libId` to Rstest format.

```ts
// For testing the 'core' environment
export default defineConfig({
  extends: withRslibConfig({
    libId: 'core',
  }),
  // core-specific test config
});
```

When you need to test multiple parts of your application with different configurations independently, you can define multiple Rstest projects. Each project can extend a specific lib configuration by setting the `libId` option.

```ts
export default defineConfig({
  projects: [
    {
      extends: withRslibConfig({ libId: 'node' }),
      include: ['tests/node/**/*.{test,spec}.?(c|m)[jt]s'],
    },
    {
      extends: withRslibConfig({ libId: 'react' }),
      include: ['tests/react/**/*.{test,spec}.?(c|m)[jt]s?(x)'],
    },
  ],
});
```

#### `modifyLibConfig`

- **Type:** `(config: RslibConfig) => RslibConfig | void`
- **Default:** `undefined`

Modify the Rslib config before it gets converted to Rstest config:

```ts
export default defineConfig({
  extends: withRslibConfig({
    modifyLibConfig: (libConfig) => {
      delete libConfig.source?.define;
      return libConfig;
    },
  }),
});
```

## Configuration mapping

The adapter automatically maps these Rslib options to Rstest:

| Rslib option          | Rstest equivalent     | Notes                                                  |
| --------------------- | --------------------- | ------------------------------------------------------ |
| `lib.id`              | `name`                | Library identifier                                     |
| `plugins`             | `plugins`             | Plugin configuration                                   |
| `source.decorators`   | `source.decorators`   | Decorator support                                      |
| `source.define`       | `source.define`       | Global constants                                       |
| `source.include`      | `source.include`      | Source inclusion patterns                              |
| `source.exclude`      | `source.exclude`      | Source exclusion patterns                              |
| `source.tsconfigPath` | `source.tsconfigPath` | TypeScript config path                                 |
| `resolve`             | `resolve`             | Module resolution                                      |
| `output.cssModules`   | `output.cssModules`   | CSS modules configuration                              |
| `tools.rspack`        | `tools.rspack`        | Rspack configuration                                   |
| `tools.swc`           | `tools.swc`           | SWC configuration                                      |
| `tools.bundlerChain`  | `tools.bundlerChain`  | Bundler chain configuration                            |
| `output.target`       | `testEnvironment`     | 'happy-dom' for web, 'node' for node and other targets |

## Debug config

To see the resolved configuration returned by the adapter, wrap it and log the result:

```typescript
export default defineConfig({
  extends: async (user) => {
    const config = await withRslibConfig({ libId: 'react' })(user);
    console.log('Extended config:', JSON.stringify(config, null, 2));
    return config;
  },
});
```

## Related documentation

- [`@rstest/adapter-rslib` documentation](https://www.npmjs.com/package/@rstest/adapter-rslib)
- [Rslib configuration overview](https://rslib.rs/config)
- [Rstest configuration overview](/config/)
